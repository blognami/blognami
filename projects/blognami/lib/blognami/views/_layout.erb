<%
    posts = database.posts
    posts = posts.published_eq(true) if !signed_in?
    featured_posts = posts.featured_eq(true)
    tags = posts.tags.order_by(:name)
    posts = posts.order_by(:published, :asc) if signed_in?
%>
<!DOCTYPE html>
<% html :lang => site.language do %>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <% title params[:title] || site.title %>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,700&family=Inter:wght@400;500;600;700;800&display=swap">
        <link rel="stylesheet" href="/assets/stylesheets/all.css">
        <script src="/assets/javascripts/pinstripe.js"></script>
    </head>
    
    <body>
        <div class="navbar">
            <div class="navbar-inner">
                <div class="navbar-brand">
                    <a class="navbar-item" href="/"><%= site.title %></a>
                </div>
                <div class="navbar-menu">
                    <% if signed_in? %>
                        <div class="navbar-item has-dropdown">
                            Add
                            <div class="navbar-dropdown">
                                <% a "Page", :class => "navbar-item", :href => "/admin/add_page?user_id=#{user.id}", :target => "_overlay" %>
                                <% a "Post", :class => "navbar-item", :href => "/admin/add_post?user_id=#{user.id}", :target => "_overlay" %>
                            </div>
                        </div>
                        <a class="navbar-item" href="/sign_out" target="_overlay">Sign out</a>
                    <% else %>
                        <a class="navbar-item" href="/sign_in" target="_overlay">Sign in</a>
                    <% end %>
                </div>
            </div>
        </div>
        <div class="site">
            <main id="main" class="main outer">
                <div class="inner">
                    <div class="wrapper">

                        <% yield %>

                        <aside class="sidebar">
                            <section class="section">
                                <h2 class="section-title">About</h2>
                                <% if signed_in? %>
                                    <div class="editable-area">
                                        <div class="editable-area-header">
                                            <a class="editable-area-button" href="/admin/edit_site_description" target="_overlay">Edit</a>
                                        </div>
                                        <div class="editable-area-body">
                                            <% render_markdown(site.description) %>
                                        </div>
                                    </div>
                                <% else %>
                                    <% render_markdown(site.description) %>
                                <% end %>
                            </section>
                            <% if featured_posts.count > 0 %>
                                <section class="section">
                                    <h3 class="section-title">Featured</h3>
                                    <div class="featured feed">
                                        <% render_view '_posts', posts: featured_posts %>
                                    </div>
                                </section>
                            <% end %>

                            <% if tags.count > 0 %>
                                <section class="section">
                                    <h3 class="section-title">Tags</h3>
            
                                    <div class="tags">
                                        <% tags.each do |tag| %>
                                            <% a :class => "tags-item", :href => "/#{tag.slug}" do %>
                                                <h3 class="tags-name"><%= tag.name %></h3>
                                                <span class="tags-count">
                                                    <%
                                                        tag_count = posts.tagged_with(tag.name).count
                                                        if tag_count == 1
                                                            text "1 post"
                                                        else
                                                            text "#{tag_count} posts"
                                                        end
                                                    %>
                                                </span>
                                            <% end %>
                                        <% end %>
                                    </div>
                                </section>
                            <% end %>
                        </aside>
                    </div>
                </div>
            </main>
            <footer class="foot outer">
                <div class="foot-inner inner">
                    <div class="copyright">
                        <%= site.title %> Â© <%= Time.now.strftime("%Y") %>
                    </div>    
                    <div class="powered-by">
                        <a href="https://blognami.org/" target="_blank" rel="noopener">Powered by Blognami</a>
                    </div>
                </div>
            </footer>
        </div>
    </body>
<% end %>
