<%
    post = params[:post]

    previous_post = posts.id_ne(post.id).published_at_lt(post.published_at).order_by(:published_at, :desc).first
    next_post = posts.id_ne(post.id).published_at_gt(post.published_at).order_by(:published_at, :asc).first
%>
<% render_view "_layout", title: post.title do %>
    <section class="section">
        <article class="article">
            <header class="article-header canvas">
                <span class="article-meta">
                    By <% a post.user.name, :href => "/#{post.user.slug}" %>
                    <% 
                        if post.tags.count > 0
                            text " in "
                            post.tags.all.each_with_index do |tag, i|
                                text ", " if i > 0
                                a tag.name, :class => "article-tag", :href => "/#{tag.slug}"
                            end
                        end
                    %>
                    <% if post.published_at %>
                        â€”
                        <% time post.published_at.strftime("%b %d, %Y"), :datetime => post.published_at.strftime("%Y-%m-%d") %>
                    <% end %>
                </span>

                <% if role?(:admin) %>
                    <div class="editable-area">
                        <div class="editable-area-header">
                            <% a "Edit", :class => "editable-area-button", :href => "/admin/edit_post_title?id=#{post.id}", :target => "_overlay" %>
                        </div>
                        <div class="editable-area-body">
                            <% h1 post.title, :class => "article-title" %>
                        </div>
                    </div>
                <% else %>
                    <% h1 post.title, :class => "article-title" %>
                <% end %>
            </header>

            <div class="content canvas">
                <% if role?(:admin) %>
                    <div class="editable-area">
                        <div class="editable-area-header">
                            <% a "Edit", :class => "editable-area-button", :href => "/admin/edit_post_body?id=#{post.id}", :target => "_overlay" %>
                        </div>
                        <div class="editable-area-body content canvas">
                            <% render_markdown(post.body) %>
                        </div>
                    </div>

                    <div class="editable-area">
                        <div class="editable-area-header">
                            <% a "Edit", :class => "editable-area-button", :href => "/admin/edit_post_meta?id=#{post.id}", :target => "_overlay" %>
                        </div>
                        <div class="editable-area-body">
                            <section class="section">
                                <h3 class="section-title">Meta</h3>
                                <p><b>Slug:</b> <%= post.slug %></p>
                                <p>
                                    <b>Tags:</b> 
                                    <%
                                        tags = post.tags.all
                                        if tags.count > 0
                                            text tags.map(&:name).join(', ')
                                        else
                                            text 'none'
                                        end
                                    %>
                                </p>
                                <p><b>Featured:</b> <%= post.featured ? 'true' : 'false' %></p>
                                <p><b>Published:</b> <%= post.published ? 'true' : 'false' %></p>
                            </section>
                        </div>
                    </div>

                    <section class="section">
                        <h3 class="section-title">Danger area</h3>
                        <p>
                            <% 
                                button "Delete this Post", {
                                    :class => "button is-primary",
                                    "data-component" => "pinstripe-anchor",
                                    "data-method" => "post",
                                    "data-href" => "/admin/delete_post?id=#{post.id}",
                                    "data-target" => "_overlay",
                                    "data-confirm" => "Are you really sure you want to delete this post?"
                                }
                            %>
                        </p>
                    </section>
                <% else %>
                    <% render_markdown(post.body) %>
                <% end %>
            </div>

            <footer class="article-footer canvas">
                <nav class="navigation">
                    <div class="navigation-previous">
                        <% if previous_post %>
                            <% a :class => "navigation-link", :href => "/#{previous_post.slug}" do %>
                                <span class="navigation-label">Previous issue</span>
                                <% h4 previous_post.title, :class => "navigation-title" %>
                            <% end %>
                        <% end %>
                    </div>

                    <div class="navigation-middle"></div>

                    <div class="navigation-next">
                        <% if next_post %>
                            <% a :class => "navigation-link", :href => "/#{next_post.slug}" do %>
                                <span class="navigation-label">Next issue</span>
                                <% h4 next_post.title, :class => "navigation-title" %>
                            <% end %>
                        <% end %>
                    </div>
                </nav>
            </footer>
        </article>
    </section>
<% end %>
