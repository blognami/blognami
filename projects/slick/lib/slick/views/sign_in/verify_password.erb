<%
    model = create_model do
        must_not_be_blank :password

        validate_with  do
            if !validation_error?(:password)
                user = Slick.database.users.email_eq(Slick.params[:email]).first
                if !user || !user.verify_password(password)
                    set_validation_error(:general, "Either your email (\"#{Slick.params[:email]}\") or password is incorrect.")
                end
            end
        end 
    end

    render_form(model, {
        title: 'Sign In',
        fields: [{ name: 'password', type: 'password', label: 'Your one-time-password', placeholder: 'Enter the one-time-password that has just been sent to you (via email).' }],
        success: Proc.new do
            user = users.email_eq(params[:email]).first
            user.log_successful_sign_in
            pass_string = SecureRandom.uuid
            session = sessions.insert({
                user_id: user.id,
                pass_string: pass_string,
                last_accessed_at: Time.now
            })

            response.headers['Set-Cookie'] = "slick_session=#{session.id}:#{pass_string}; Path=/";

            span "data-node-wrapper" => "anchor", "data-target" => "_top", "data-trigger" => "click"
        end
    })
%>