FROM node:22-bookworm

# Install Playwright Chromium + system dependencies (needs root)
ENV PLAYWRIGHT_BROWSERS_PATH=/opt/playwright-browsers
RUN npx playwright@1.56.0 install --with-deps chromium

# Install Stripe CLI
RUN curl -s https://packages.stripe.dev/api/security/keypair/stripe-cli-gpg/public | gpg --dearmor -o /usr/share/keyrings/stripe.gpg && \
    echo "deb [signed-by=/usr/share/keyrings/stripe.gpg] https://packages.stripe.dev/stripe-cli-debian-local stable main" > /etc/apt/sources.list.d/stripe.list && \
    apt-get update && apt-get install -y stripe sqlite3 && rm -rf /var/lib/apt/lists/*

# Install Claude CLI globally
RUN npm install -g @anthropic-ai/claude-code

# Create non-root user (Claude CLI refuses bypassPermissions as root)
RUN useradd -m -s /bin/bash ralph

WORKDIR /app

# Pre-create node_modules owned by ralph so the named volume inherits ownership
RUN mkdir -p node_modules && chown ralph:ralph node_modules

USER ralph

ARG GIT_USER_NAME="Ralph (Docker)"
ARG GIT_USER_EMAIL="ralph@localhost"
RUN git config --global user.name "$GIT_USER_NAME" && \
    git config --global user.email "$GIT_USER_EMAIL"

# Skip onboarding prompt (required for headless auth via CLAUDE_CODE_OAUTH_TOKEN)
RUN echo '{"hasCompletedOnboarding": true}' > /home/ralph/.claude.json

CMD ["sh", "-c", "if [ ! -f node_modules/.package-lock.json ]; then npm install; fi && node scripts/ralph.js \"${RALPH_ITERATIONS:-10}\""]
